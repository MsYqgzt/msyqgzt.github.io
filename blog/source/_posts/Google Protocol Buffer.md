---
title: Google Protocol buffers
tags: [ç¼–ç¨‹]
categories: 
- [æ•°æ®ç»“æ„]
mathjax: true
date: 2021-02-23
---



## Protocol buffer ç®€ä»‹

`Protocol Buffer`æ˜¯Googleæå‡ºçš„ä¸€ç§æ”¯æŒå¤šå¹³å°ã€å¤šè¯­è¨€ã€å¯æ‰©å±•çš„çš„æ•°æ®åºåˆ—åŒ–æœºåˆ¶ï¼Œç›¸è¾ƒäºXMLæ¥è¯´ï¼Œ`protobuf`æ›´å°æ›´å¿«æ›´ç®€å•ï¼Œæ”¯æŒè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œç”¨`protobuf`ç¼–è¯‘å™¨ç”Ÿæˆç‰¹å®šè¯­è¨€çš„æºä»£ç ï¼Œå¦‚C++ã€Javaã€Pythonï¼Œç›®å‰`protobuf`å¯¹ä¸»æµçš„ç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†æ”¯æŒ,éå¸¸æ–¹ä¾¿çš„è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

[> Protocol Bufferå®˜æ–¹æ–‡æ¡£](https://developers.google.com/protocol-buffers)



### Protocol Buffer ä¸ XMLã€JSON çš„åŒºåˆ«

- `Protocol Buffer` å’Œ `XML`ã€`JSON`ä¸€æ ·éƒ½æ˜¯*ç»“æ„æ•°æ®åºåˆ—åŒ–*çš„å·¥å…·ï¼Œä½†å®ƒä»¬çš„æ•°æ®æ ¼å¼æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ï¼š
  - é¦–å…ˆï¼ŒProtocol Buffer åºåˆ—åŒ–ä¹‹åå¾—åˆ°çš„æ•°æ®ä¸æ˜¯å¯è¯»çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯**äºŒè¿›åˆ¶æµ**
  - å…¶æ¬¡ï¼ŒXML å’Œ JSON æ ¼å¼çš„æ•°æ®ä¿¡æ¯éƒ½åŒ…å«åœ¨äº†åºåˆ—åŒ–ä¹‹åçš„æ•°æ®ä¸­ï¼Œä¸éœ€è¦ä»»ä½•å…¶å®ƒä¿¡æ¯å°±èƒ½è¿˜åŸåºåˆ—åŒ–ä¹‹åçš„æ•°æ®ï¼›ä½†ä½¿ç”¨ Protocol Buffer éœ€è¦äº‹å…ˆå®šä¹‰æ•°æ®çš„æ ¼å¼(`.proto` åè®®æ–‡ä»¶)ï¼Œ**è¿˜åŸ**ä¸€ä¸ªåºåˆ—åŒ–ä¹‹åçš„æ•°æ®**éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªå®šä¹‰å¥½çš„æ•°æ®æ ¼å¼**
  - æœ€åï¼Œåœ¨ä¼ è¾“æ•°æ®é‡è¾ƒå¤§çš„éœ€æ±‚åœºæ™¯ä¸‹ï¼Œ`Protocol Buffer` æ¯” `XML`ã€`JSON` **æ›´å°ï¼ˆ3åˆ°10å€ï¼‰ã€æ›´å¿«ï¼ˆ20åˆ°100å€ï¼‰ã€ä½¿ç”¨ & ç»´æŠ¤æ›´ç®€å•**ï¼›è€Œä¸” `Protocol Buffer` å¯ä»¥è·¨å¹³å°ã€è·¨è¯­éŸ³ä½¿ç”¨

## `.proto`æ–‡ä»¶è¯­æ³•

- `package`åœ¨Javaé‡Œé¢ä»£è¡¨è¿™ä¸ªæ–‡ä»¶æ‰€åœ¨çš„åŒ…åï¼Œåœ¨c#é‡Œé¢ä»£è¡¨è¯¥æ–‡ä»¶çš„å‘½åç©ºé—´ï¼›
- `message`ä»£è¡¨ä¸€ä¸ªç±»ï¼›
- `required`ä»£è¡¨è¯¥å­—æ®µå¿…å¡«
- `optional`ä»£è¡¨è¯¥å­—æ®µå¯é€‰ï¼Œå¹¶å¯ä»¥ä¸ºå…¶è®¾ç½®é»˜è®¤å€¼`[defalut=å€¼]` 

### Messageå®šä¹‰

ä¸€ä¸ªæœç´¢è¯·æ±‚çš„`message`æ ¼å¼çš„ç®€å•ğŸŒ°

```protobuf
syntax = "proto3";//å®šä¹‰protoç‰ˆæœ¬

//messageåŒ…å«å¤šä¸ªç§ç±»çš„fields
message SearchRequest {
	string query = 1;
	int32 page_number = 2;
	int32 result_per_page = 3;
}
```

ä¸Šè¿°ä¾‹å­ä¸­`fields`çš„ç§ç±»éƒ½æ˜¯æ•°å€¼å‹çš„ï¼ˆ`string`å’Œ`int32`ï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šæ›´åŠ å¤æ‚çš„`fields`ï¼Œæ¯”å¦‚æšä¸¾ç±»å‹`enum`ï¼Œæˆ–è€…æ˜¯åµŒå¥—çš„`message`ç±»å‹

#### åˆ†é…fieldç¼–å·

ä¸Šè¿°ä¾‹å­ä¸­æ¯ä¸ª`field`éƒ½è¢«åˆ†é…äº†ä¸€ä¸ªç¼–å·ï¼Œè¿™ä¸ªç¼–å·æ˜¯è¿™ä¸ª`field`çš„å”¯ä¸€æ ‡è¯†ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æ ‡è¯†1-15åœ¨ç¼–ç çš„æ—¶å€™åªå ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œ16-2047å ç”¨ä¸¤ä¸ªå­—èŠ‚**ï¼Œæ‰€ä»¥ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æˆ‘ä»¬çš„ç¨‹åºï¼Œå¯¹äºé‚£ç§ç»å¸¸å‡ºç°çš„elementï¼Œå»ºè®®ä½¿ç”¨1-15æ¥ä½œä¸ºä»–ä»¬çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯¹é‚£äº›ä¸è¢«ç»å¸¸ä½¿ç”¨çš„elementï¼Œå»ºè®®ä½¿ç”¨16-2047ï¼Œç¼–å·çš„èŒƒå›´æ˜¯$1-2^{29}$ï¼ˆ19000-19999æ˜¯ç³»ç»Ÿé¢„ç•™çš„ï¼Œä¸è¦ä½¿ç”¨ï¼‰

#### fieldç±»å‹

`message`å½“ä¸­çš„`field`ç±»å‹åŒ…å«ä»¥ä¸‹ä¸¤ç§ï¼ˆproto3ï¼‰ï¼š

- singular

- repeatedï¼šè¯¥ç±»å‹çš„fieldå¯ä»¥åœ¨messageä¸­é‡å¤ä½¿ç”¨ï¼ˆç±»ä¼¼äºæ•°ç»„ï¼‰ï¼Œä»–ä»¬çš„é¡ºåºä¼šè¢«ä¿å­˜ï¼Œé€šè¿‡ç´¢å¼•è¿›è¡Œæ£€ç´¢ï¼Œæ•°å€¼ç±»å‹çš„repeatedé»˜è®¤ä½¿ç”¨packedç¼–ç æ–¹å¼

#### å¤šmessageç»“æ„

åœ¨ä¸€ä¸ªprotoæ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª`protobuf`

#### reserved fieldç±»å‹

åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ¶‰åŠåˆ°å¯¹protoæ–‡ä»¶ä¸­`message`å„ä¸ªfieldsçš„ä¿®æ”¹ï¼Œå¯èƒ½æ˜¯æ›´æ–°ã€åˆ é™¤æŸä¸ªfieldåŠå…¶è¡¨ç¤ºï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨çš„æœåŠ¡å¤±è´¥ã€‚

å…¶ä¸­ä¸€ä¸ªé˜²æ­¢è¿™ç§é—®é¢˜çš„æ–¹å¼æ˜¯ï¼Œç¡®ä¿ä½ è¦åˆ é™¤çš„`field`çš„æ ‡è¯†ï¼ˆæˆ–æ˜¯åå­—ï¼‰æ˜¯`reserved`ï¼Œå…·ä½“`protobuf`çš„ç¼–è¯‘å™¨ä¼šå†³å®šæœªæ¥è¿™ä¸ªfieldè¡¨ç¤ºèƒ½å¦è¢«ä½¿ç”¨

```protobuf
//æ•°å­—æ ‡è¯†å’Œå‘½åä¸èƒ½åœ¨åŒä¸€æ¡è¯­å¥ä¸­æ··åˆå£°æ˜
message Foo {
  reserved 2, 15, 9 to 11;
  reserved "foo", "bar";
}
```

#### ç¼–è¯‘ç»“æœ

ä½¿ç”¨`protoc`ç¼–è¯‘ä¸€ä¸ª`.proto`æ–‡ä»¶

{% fold è¿™é‡Œæ˜¯æˆ‘ä¸ªäººçš„ç¼–è¯‘æ–¹å¼ %}

1. æ‰¾åˆ°`google.protobuf.tools`åŒ…æ‰€åœ¨ç›®å½•ä¸‹çš„`protoc.exe`æ–‡ä»¶
2. åœ¨è¿™ä¸ªæ–‡ä»¶ç›®å½•ä¸‹åˆ›å»º`src`å’Œ`gen`æ–‡ä»¶å¤¹
3. å°†è‡ªå·±çš„`xx.proto`æ–‡ä»¶ç§»åŠ¨åˆ°`src`æ–‡ä»¶å¤¹å†…
   - `.proto`æ–‡ä»¶ä¹‹é—´å¯ä»¥äº’ç›¸å¼•ç”¨ï¼Œè¦æ­£å¸¸ä½¿ç”¨ï¼Œå¿…é¡»æŠŠæ‰€æœ‰ç›¸å…³çš„protoæ–‡ä»¶éƒ½å‡†å¤‡å¥½
4. åœ¨`protoc.exe`æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰“å¼€å‘½ä»¤è¡Œï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
.\protoc.exe --proto_path=src --csharp_out=gen xx.proto
```

5. åœ¨`gen`æ–‡ä»¶å¤¹ä¸­ä¼šäº§ç”Ÿç­‰é‡çš„`.cs`æ–‡ä»¶ï¼Œè¿™å°±æ˜¯å¯¹åº”çš„**è§£ç å™¨**ï¼ŒæŠŠå®ƒä»¬å¯¼å…¥è‡ªå·±çš„é¡¹ç›®ä¸­

{% endfold %}

### æ•°æ®ç±»å‹

å…·ä½“çš„`proto`ç±»å‹å¯¹åº”çš„ç”Ÿæˆç±»ä¸­çš„ç±»å‹å¯å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://developers.google.com/protocol-buffers/docs/proto3#scalar)

### é»˜è®¤å€¼

- å¯¹äº`string`å’Œ`byte`ç±»å‹ï¼Œé»˜è®¤å€¼ä¸ºç©ºï¼›
- å¯¹äº`bool`ç±»å‹ï¼Œé»˜è®¤å€¼æ˜¯`false`ï¼›
- å¯¹äºæ•°å€¼ç±»å‹ï¼Œé»˜è®¤å€¼æ˜¯0ï¼›
- å¯¹äºæšä¸¾ç±»å‹ï¼Œé»˜è®¤å€¼æ˜¯ç¬¬ä¸€ä¸ªæšä¸¾å€¼ï¼Œé»˜è®¤ä¸º0ï¼›
- å¯¹äº`message`ç±»å‹ï¼Œé»˜è®¤å€¼ç”±ç¼–ç¨‹è¯­è¨€å†³å®šï¼›
- å¯¹äº`repeated field`ï¼Œé»˜è®¤å€¼ä¸ºç©º



### æšä¸¾ç±»å‹

å½“é‡‡ç”¨æšä¸¾ç±»å‹ä¹‹åï¼Œæšä¸¾ä¸­çš„å€¼éƒ½æ˜¯é¢„å…ˆå®šä¹‰å¥½çš„ï¼Œå¯¹äºä¸Šè¿°ä¾‹å­ï¼Œå¯ä»¥å†é¢å¤–å¢åŠ ä¸€ä¸ªæšä¸¾ç±»å‹corpusï¼Œå…·ä½“å¦‚ä¸‹

```protobuf
message SearchRequest {
	string query = 1;
	int32 page_number = 2;
	int32 result_per_page = 3;
	enum Corpus {
	  UNIVERSAL = 0;
	  WEB = 1;
	  IMAGES = 2;
	  LOCAL = 3;
	  NEWS = 4;
	  PRODUCTS = 5;
	  VIDEO = 6;
	}
	Corpus corpus = 4;
  }
```

é€šå¸¸æšä¸¾ç±»å‹çš„ç¬¬ä¸€ä¸ªå€¼åˆå§‹åŒ–ä¸º0ï¼Œè€Œä¸”åœ¨`message`ä¸­ä½¿ç”¨æšä¸¾ç±»å‹ï¼Œ**å¿…é¡»è¦ç»™å®šä¸€ä¸ªä¸º0çš„å€¼ï¼Œè€Œä¸”è¿™ä¸ªä¸º0çš„å€¼åº”è¯¥ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ **

æŒ‡å®š`option allow_alias = true;`æ¥å®¹è®¸ä¸¤ä¸ªæšä¸¾å…ƒç´ æœ‰ç›¸åŒçš„å€¼ï¼Œå³è¿™ä¸¤ä¸ªå…ƒç´ èƒ½å¤Ÿç›¸äº’æ›¿ä»£

```protobuf
enum EnumAllowingAlias {
  option allow_alias = true;
  UNKNOWN = 0;
  STARTED = 1;
  RUNNING = 1;
}

enum EnumNotAllowingAlias {
  UNKNOWN = 0;
  STARTED = 1;
  // RUNNING = 1;//å–æ¶ˆæ³¨é‡Šè¿™ä¸€è¡Œï¼Œå°†å¯¼è‡´Googleå†…éƒ¨å‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œå¹¶åœ¨å¤–éƒ¨å‡ºç°è­¦å‘Šæ¶ˆæ¯ã€‚
}
```

æ­¤å¤–ï¼Œæšä¸¾ç±»å‹ä¸ä»…å¯ä»¥å®šä¹‰åœ¨`message`å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨`message`å¤–éƒ¨ï¼Œè€Œä¸”åœ¨ä¸åŒmessageä¸­å¯ä»¥é‡ç”¨`enum`ã€‚

åœ¨æ›´æ”¹æšä¸¾ç±»å‹`field`æ—¶ï¼Œä¸ºä¿è¯ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼ŒåŒæ ·å¯ä»¥æŒ‡å®š`reserved`æ•°å­—æ ‡è¯†å’Œå‘½å



### ä½¿ç”¨å…¶ä»–messageç±»å‹

#### åŒæ–‡ä»¶å¼•ç”¨

```protobuf
message SearchResponse {
  repeated Result results = 1;
}

message Result {
  string url = 1;
  string title = 2;
  repeated string snippets = 3;
}
```

#### ä¸åŒæ–‡ä»¶å¼•ç”¨

å¼•ç”¨å…¶ä»–protoæ–‡ä»¶ä¸­å®šä¹‰å¥½çš„messageç±»å‹

```protobuf
import "myproject/other_protos.proto";
```

æœ‰æ—¶æˆ‘ä»¬ä¼šå¯¹å¼•ç”¨çš„`proto`æ–‡ä»¶è¿›è¡Œæ›´æ”¹ï¼Œæ¯”å¦‚å°†å…¶å†…å®¹ç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±éœ€è¦å¯¹è°ƒç”¨æ–¹importè·¯å¾„è¿›è¡Œæ›´æ”¹ï¼Œå½“è°ƒç”¨æ–¹éå¸¸å¤šçš„æ—¶å€™ï¼Œè¿™ç§æ–¹æ³•æ˜¯éå¸¸ä½æ•ˆçš„ã€‚

`protobuf`æä¾›ä¸€ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŸæœ‰ä½ç½®æä¾›ä¸€ä¸ªæ–°ä½ç½®`proto`æ–‡ä»¶çš„â€œå‰¯æœ¬â€ï¼Œé€šè¿‡ä½¿ç”¨`import public`è¡¨ç¤ºæ¥å®ç°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ä¾‹å­

```protobuf
// new.proto
// All definitions are moved here

// old.proto
// This is the proto that all clients are importing.
import public "new.proto";
import "other.proto";

// client.proto
import "old.proto";
// You use definitions from old.proto and new.proto, but not other.proto
```

è¿™æ—¶ç¼–è¯‘å™¨å°±ä¼šåœ¨æŸäº›å›ºå®šç›®å½•ä¸‹æŸ¥è¯¢importçš„`proto`æ–‡ä»¶ï¼ˆå…·ä½“åœ¨å‘½ä»¤è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œç”±`-I/â€”proto_path`æŒ‡å®šï¼‰ï¼Œå¦‚æœä¸Šè¿°è·¯å¾„æ‰¾ä¸åˆ°ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨è·¯å¾„è¿›è¡ŒæŸ¥æ‰¾ã€‚é€šå¸¸å°†`â€”proto_path`è®¾ç½®ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ï¼Œç„¶åimportçš„æ—¶å€™ä½¿ç”¨å®Œæ•´çš„è·¯å¾„å

> proto2ä¸­çš„æšä¸¾ç±»å‹æ— æ³•ç›´æ¥ä½¿ç”¨

### åµŒå¥—ç±»å‹

å…·ä½“å¦‚ä¸‹

``` protobuf
message SearchResponse {
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
  repeated Result results = 1;
}
```

åœ¨parent`message`ä¹‹å¤–è°ƒç”¨åµŒå¥—çš„`message`å¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ï¼š`SearchResponse.Result`ï¼ŒåµŒå¥—ç»“æ„å¯ä»¥æ›´åŠ å¤æ‚ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

``` protobuf
message Outer {       // Level 0
  message MiddleAA {  // Level 1
    message Inner {   // Level 2
      int64 ival = 1;
      bool  booly = 2;
    }
  }
  message MiddleBB {  // Level 1
    message Inner {   // Level 2
      int32 ival = 1;
      bool  booly = 2;
    }
  }
}
```

### æ›´æ–°messageç±»å‹

å½“ç°æœ‰çš„`message`å·²ç»æ— æ³•æ»¡è¶³ç°æœ‰ä¸šåŠ¡éœ€è¦ï¼Œä½ éœ€è¦æ›´æ–°ä½ çš„`message`ç±»å‹ä»¥æ”¯æŒæ›´å¤æ‚çš„ä¸šåŠ¡ï¼Œè¿™å°±æ¶‰åŠåˆ°å‘åå…¼å®¹çš„é—®é¢˜äº†ï¼Œä¸ºä¿è¯å·²æœ‰æœåŠ¡ä¸å—å½±å“ï¼Œéœ€è¦éµå®ˆä»¥ä¸‹çš„ä¸€äº›è§„å®š

1. ä¸è¦æ›´æ”¹å·²ç»å­˜åœ¨çš„`fields`çš„æ•°å­—æ ‡è¯†

2. å¦‚æœæ·»åŠ æ–°çš„`field`ï¼Œåˆ©ç”¨æ—§ä»£ç åºåˆ—åŒ–å¾—åˆ°çš„`message`å¯ä»¥ä½¿ç”¨æ–°çš„ä»£ç è¿›è¡Œè§£æï¼Œä½ éœ€è¦è®°ä½å„ä¸ªå…ƒç´ çš„é»˜è®¤å€¼ã€‚æ–°ä»£ç åˆ›å»ºçš„`field`åŒæ ·å¯ä»¥ç”±æ—§ä»£ç è¿›è¡ŒåŠ è§£æ

3. `field`å¯ä»¥è¢«åˆ é™¤ï¼Œä½†æ˜¯éœ€è¦ä¿è¯å…¶å¯¹åº”çš„æ•°å­—æ ‡è¯†ä¸å†è¢«ä½¿ç”¨ï¼Œä½ å¯ä»¥é€šè¿‡åŠ å‰ç¼€çš„æ–¹å¼æ¥é‡æ–°ä½¿ç”¨è¿™ä¸ª`field name`ï¼Œæˆ–è€…æŒ‡å®šæ•°å­—æ ‡è¯†ä¸º`reserved`æ¥é¿å…è¿™ç§æƒ…å†µ

4. `int32`ã€`int64`ã€`uint32`ã€`uint64`ã€`bool`è¿™äº›ç±»å‹éƒ½æ˜¯äº’ç›¸å…¼å®¹çš„ï¼Œå¹¶ä¸ä¼šå½±å“å‰å‘ã€åå‘å…¼å®¹æ€§

5. `sint32`å’Œ`sint64`ä¹‹é—´æ˜¯äº’ç›¸å…¼å®¹çš„ï¼Œä½†æ˜¯å’Œå…¶ä»–æ•°å­—ç±»å‹æ˜¯ä¸å…¼å®¹çš„

6. `string`å’Œ`bytes`æ˜¯äº’ç›¸å…¼å®¹çš„ï¼Œåªè¦ä½¿ç”¨çš„æ˜¯`UTF-8`ç¼–ç 

7. å¦‚æœ`byte`åŒ…å«`message`çš„ç¼–ç ç‰ˆæœ¬ï¼Œåˆ™åµŒå¥—çš„`message`å’Œ`bytes`å…¼å®¹

8. `flexed32`å…¼å®¹`sfixed32`,`fixed64`,`sfixed64`

9. `enum`å…¼å®¹`int32`ï¼Œ`uint32`ï¼Œ`int64`and `uint64`ã€‚å¯¹äºè¿™ä¸ªå€¼åœ¨è½¬åŒ–æ—¶ï¼Œä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯å¤„ç†æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒ



å‚è€ƒèµ„æ–™ï¼š

1. [Protocol Bufferè¯¦è§£](https://zhuanlan.zhihu.com/p/95869546)