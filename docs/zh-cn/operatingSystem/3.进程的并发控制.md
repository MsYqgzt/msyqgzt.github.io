# 进程的并发控制

## 互斥、同步与并发的区别

### 互斥

> 只要不同时使用即可，谁先用谁后用没有约束——此之谓“互斥”
>
> 互斥体现进程间**竞争关系**

### 同步

> 不但不能同时用，谁先用谁后用也有严格约束——此之谓“同步”
>
> 同步—体现进程间协作关系

<br/>

## 并发(Concurrency)
### 并发的基本概念
- 单处理器多道程序设计系统中，多个进程交替执行
- 多个并发进程在一个时间段内都处于运行状态
- 共享系统资源
- 每个进程都“走走停停”
- 并发带来异步性

### 并发带来的问题

- 并发进程的相对执行速度是不可预测的，取决于其他进程的活动、操作系统处理中断的方式以及操作系统的调度策略。
- 有可能发生各种与时间有关的错误。

### 与并发相关的关键术语

- 临界资源(Critical resources)
  - 也叫互斥资源
  - 一种一次只能为一个进程服务的共享资源
  - 如前述“存款额”、 Buffer块
- 临界区(Critical Section)
  - 进程体中使用临界资源的代码段
  - 使用同一临界资源的不同的代码段叫做相关临界区
  - 当一个进程已经在临界区中运行时，也就是已经在使用临界资源了，其它进程不能进入相关临界区
- 互斥(Mutual Exclusion)
  - 当一个进程在临界区访问临界资源时，其他进程不能进入相关临界区访问该资源
  - 临界资源一个时刻只允许一个进程使用
  - 进程使用该临界资源的顺序没有约束
  - 体现竞争关系
- 同步(Synchronization)
  - 不但不能同时使用临界资源，还得有严格的使用的先后顺序
  - 体现协作关系
- 死锁(Dead lock)
  - 两个或两个以上的进程，因其中的每个进程都在等待其他进程做完某些事情而不能继续执行，所有进程都阻塞等待，而且永远阻塞等待
- 活锁(Live lock)
  - 两个或两个以上进程为了响应其他进程中的变化而持续改变自己的状态，但不做有用的工作
- 饥饿(Starvation)
  - 一个可运行的进程被调度程序无限期地忽略，不能被调度执行的情形。
- 原子操作(Primitive)
  - 保证指令序列要么作为一个组来执行，要么都不执行

------

操作系统在管理和控制资源分配与使用方面，应当保证进程对临界资源的访问满足以下3点：

1. 互斥访问要求。
2. 不致于产生“死锁”
3. 不能有“饥饿”进程

<br/>

## 解决进程同步和互斥的方法
> **互斥管理准则：**
>
> 空闲让进、忙则等待、有限等待、让权等待

### 软件方法

软件方法解决互斥问题失败的原因：

1. 临界区前后所加代码越多，执行过程随时被打断的情况越多
2. 所加代码中的turn、Fag[1]、Flag[2]本身也是临界资源
3. 没有考虑让权等待

### 硬件方法



### 信号量机制

>**基本原理：**
>
>- 两个或多个进程通过简单的信号进行合作。
>
>- 任何复杂的合作需求都可以通过适当的信号结构得到满足。
>
>实现要素：
>
>- 信号量（Semaphore类型，内含一个阻塞队列）
>- P操作原语（wait）
>- V操作原语（signal）

一个记录型信号量包含两个分量：

信号量的值、信号量的等待队列指针

| P(s)                                                         | V(s)                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| s.value = s.value -1;<br/>if s.value < 0<br/>then block(s.L); | s.value = s.value +1;<br/>if s.value <= 0<br/>then wakeup(s.L); |

> 用于进临界区之前检查资源
>
> 当临界资源被其他进程占用时，就将自己阻塞
>
> 具有“阻塞”功能

|                         解决互斥问题                         |                         解决同步问题                         |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
| 一种CR设一个信号量<br/>信号量的初值设置为系统初始状态CR的可用量<br/>P操作用于临界区前，相当于进入CS之前申请CR<br/>V操作用于临界区后，相当于出临界区后释放CR<br/>P、V操作必须成对匹配 | 一种同步信号设一个信号量<br/>信号量的初值设置为系统初始状态下信号的有无<br/>P操作用于临界区前，相当于检査同步信号<br/>V操作用于临界区后，相当于发出同步信号<br/>P、V操作不成对匹配 |

互斥、同步解决方法的异同分析：
- 信号量的设置
- 信号量的初值
- P操作的含义
- V操作的含义
- P、V操作是否匹配

记录型信号量机制解决问题的步骤：
- 分析问题中的进程、资源；分析进程间关系；
- 分别设置互斥、同步信号量；
- 写出并发进程体，找出相关CS(临界区)；
- 分别加PV操作并分析结果。

### 管程机制

